name: Delete Old Cloudflare Pages Deployments

on:
  schedule:
    - cron: '0 16 * * *' # æ¯å¤©å°ç£æ™‚é–“ä¸Šåˆ11é»åŸ·è¡Œ
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install curl & jq
        run: sudo apt-get install -y curl jq

      - name: Delete Old Deployments
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
          DELETE_THRESHOLD: ${{ secrets.DELETE_THRESHOLD || 5 }}
        run: |
          set -e
          echo "ğŸ” å–å¾—éƒ¨ç½²åˆ—è¡¨..."

          DELETE_THRESHOLD=${DELETE_THRESHOLD:-5}

          deployments=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json")

          ids=$(echo "$deployments" | jq -r ".result | sort_by(.created_on) | reverse | .[$DELETE_THRESHOLD:][]?.id")

          if [ -z "$ids" ]; then
            echo "âœ… ç„¡éœ€åˆªé™¤ï¼Œéƒ¨ç½²æ•¸é‡æœªè¶…é $DELETE_THRESHOLD ç­†ã€‚"
            exit 0
          fi

          echo "ğŸ“¦ æº–å‚™åˆªé™¤ä»¥ä¸‹èˆŠéƒ¨ç½²ï¼š"
          echo "$ids"

          for id in $ids; do
            echo "ğŸ—‘ï¸  åˆªé™¤ deployment $id..."
            curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments/$id" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json"
          done

          echo "âœ… æ¸…é™¤å®Œæˆã€‚"
