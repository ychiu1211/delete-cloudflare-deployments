name: Delete Old Cloudflare Pages Deployments

on:
  schedule:
    - cron: '0 16 * * *' # 每天台灣時間上午11點執行
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install curl & jq
        run: sudo apt-get install -y curl jq

      - name: Delete Old Deployments
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
          DELETE_THRESHOLD: ${{ secrets.DELETE_THRESHOLD || 5 }}
        run: |
          set -e
          echo "🔍 取得部署列表..."

          DELETE_THRESHOLD=${DELETE_THRESHOLD:-5}

          deployments=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json")

          ids=$(echo "$deployments" | jq -r ".result | sort_by(.created_on) | reverse | .[$DELETE_THRESHOLD:][]?.id")

          if [ -z "$ids" ]; then
            echo "✅ 無需刪除，部署數量未超過 $DELETE_THRESHOLD 筆。"
            exit 0
          fi

          echo "📦 準備刪除以下舊部署："
          echo "$ids"

          for id in $ids; do
            echo "🗑️  刪除 deployment $id..."
            curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments/$id" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json"
          done

          echo "✅ 清除完成。"
